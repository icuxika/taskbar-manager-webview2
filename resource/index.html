<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Windows 任务栏窗口管理</title>
        <style>
            html {
                box-sizing: border-box;
            }

            *,
            *::before,
            *::after {
                margin: 0;
                padding: 0;
                box-sizing: inherit;
            }

            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(
                    to right,
                    rgb(43, 192, 228),
                    rgb(234, 236, 198)
                );
                color: #333;
                padding: 30px;
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 20px;
                height: 100vh;
                overflow: hidden; /* 防止整个页面滚动 */
            }

            h1 {
                font-size: 1.8rem;
                color: #004578;
            }

            .button-group {
                display: flex;
                gap: 12px;
                flex-wrap: wrap;
                justify-content: center;
                flex-shrink: 0; /* 防止按钮组被压缩 */
            }

            button {
                padding: 8px 18px;
                font-size: 1rem;
                background-color: #0078d4;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                transition: background-color 0.2s ease, transform 0.1s ease;
                min-width: 100px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
            }

            button:hover {
                background-color: #005fa3;
                transform: translateY(-1px);
            }

            button:active {
                transform: translateY(0);
            }

            .hotkey-card {
                background: #ffffffcc;
                padding: 16px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
                width: 100%;
                max-width: 640px;
                display: flex;
                flex-direction: column;
                flex-shrink: 0; /* 防止快捷键卡片被压缩 */
            }

            .hotkey-section {
                display: flex;
                align-items: center;
                justify-content: flex-start;
            }

            .hotkey-section input[type="text"] {
                flex: 1;
                padding: 8px 10px;
                font-size: 1rem;
                border: 1px solid #ccc;
                border-radius: 6px;
                outline: none;
                transition: border 0.2s ease, box-shadow 0.2s ease;
                min-width: 180px;
            }

            .hotkey-section input[type="text"]:focus {
                border-color: #0078d4;
                box-shadow: 0 0 4px rgba(0, 120, 212, 0.4);
            }

            .hotkey-row {
                display: flex;
                align-items: center;
                justify-content: space-around;
                margin-top: 8px;
            }

            .hotkey-row button {
                flex-shrink: 0;
                padding: 8px 16px;
                font-size: 0.95rem;
            }

            .hotkey-row button.clear {
                background-color: #d83b01;
            }

            .window-list-card {
                flex: 1;
                display: flex;
                flex-direction: column;
                background: #ffffffcc;
                padding: 16px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
                width: 100%;
                max-width: 640px;
                min-height: 0; /* 允许弹性项目缩小到内容以下 */
                overflow: hidden; /* 防止卡片本身溢出 */
            }

            .filter-row {
                display: flex;
                align-items: center;
                justify-content: flex-start;
                flex-shrink: 0; /* 防止过滤行被压缩 */
            }

            .filter-row input[type="text"] {
                flex: 1;
                padding: 8px 10px;
                font-size: 1rem;
                border: 1px solid #ccc;
                border-radius: 6px;
                outline: none;
                transition: border 0.2s ease, box-shadow 0.2s ease;
                min-width: 180px;
            }

            .filter-row input[type="text"]:focus {
                border-color: #0078d4;
                box-shadow: 0 0 4px rgba(0, 120, 212, 0.4);
            }

            .window-list-row {
                flex: 1;
                min-height: 0; /* 关键：允许弹性项目缩小 */
                overflow: hidden; /* 防止容器溢出 */
            }

            /* 窗口列表样式 - 只有这里可以滚动 */
            ul#window-list {
                list-style: none;
                margin-top: 8px;
                height: 100%; /* 占满父容器 */
                overflow-y: auto; /* 只有窗口列表可以滚动 */
                padding-right: 4px; /* 为滚动条预留空间 */
            }

            /* 自定义滚动条样式 */
            ul#window-list::-webkit-scrollbar {
                width: 8px;
            }

            ul#window-list::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 4px;
            }

            ul#window-list::-webkit-scrollbar-thumb {
                background: #c1c1c1;
                border-radius: 4px;
            }

            ul#window-list::-webkit-scrollbar-thumb:hover {
                background: #a8a8a8;
            }

            ul#window-list li {
                background-color: white;
                padding: 10px 14px;
                margin-bottom: 6px;
                border-radius: 6px;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
                cursor: pointer;
                transition: background-color 0.2s ease;
            }

            ul#window-list li:hover {
                background-color: #e6f0ff;
            }
        </style>
    </head>
    <body>
        <!-- 操作按钮 -->
        <div class="button-group">
            <button type="button" onclick="quit()">退出</button>
            <button type="button" onclick="getWindows()">获取任务栏窗口</button>
        </div>

        <!-- 热键注册 -->
        <div class="hotkey-card">
            <h2 style="margin-bottom: 8px; font-size: 1.2rem">
                设置快捷键: 显示Taskbar Manager窗口
            </h2>
            <div class="hotkey-section">
                <input
                    type="text"
                    id="hotkeyInput"
                    placeholder="例如 Ctrl+Alt+T"
                    readonly
                />
            </div>
            <div class="hotkey-row">
                <button type="button" onclick="registerHotkey()">
                    注册快捷键
                </button>
                <button type="button" class="clear" onclick="clearHotkey()">
                    清除快捷键
                </button>
            </div>
        </div>

        <!-- 窗口列表 -->
        <div class="window-list-card">
            <h2 style="margin-bottom: 8px; font-size: 1.2rem">窗口列表</h2>
            <div class="filter-row">
                <input
                    type="text"
                    id="windowFilterInput"
                    placeholder="输入窗口名称过滤..."
                />
            </div>
            <div class="window-list-row">
                <ul id="window-list"></ul>
            </div>
        </div>
    </body>
    <script>
        let lastShortcut = "";

        // 退出程序
        async function quit() {
            await Native.invoke("quit", {});
        }

        // 获取任务栏程序窗口列表
        async function getWindows() {
            const data = await Native.invoke("getWindows", {});
            const ulEle = document.getElementById("window-list");
            ulEle.innerHTML = "";

            data.windows.forEach((window) => {
                const li = document.createElement("li");
                li.textContent = window.title.substring(0, 64);
                li.onclick = () => {
                    activateWindow(window.handle);
                };
                ulEle.appendChild(li);
            });
        }

        // 激活窗口
        async function activateWindow(handle) {
            await Native.invoke("activateWindow", { handle: handle });
        }

        // 注册全局快捷键
        async function registerHotkey() {
            // 系统禁止的快捷键，避免冲突
            const forbidden = [
                "Ctrl + A",
                "Ctrl + C",
                "Ctrl + V",
                "Ctrl + X",
                "Ctrl + Z",
                "Alt + Tab",
                "Alt + F4",
            ];
            if (forbidden.includes(lastShortcut)) {
                alert("该快捷键与系统快捷键冲突，无法注册");
                return;
            }

            // 拆解为结构化对象
            const parts = lastShortcut.split(" + ").map((p) => p.trim());
            const info = {
                ctrl: parts.includes("Ctrl"),
                shift: parts.includes("Shift"),
                alt: parts.includes("Alt"),
                key:
                    parts.find((p) => !["Ctrl", "Shift", "Alt"].includes(p)) ||
                    "",
            };

            if (!info.key) {
                alert("快捷键无效：缺少主键");
                return;
            }

            localStorage.setItem("lastShortcut", lastShortcut);
            const data = await Native.invoke("registerHotkey", {
                hotkey: info,
            });
        }

        // 清除全局快捷键
        async function clearHotkey() {
            const hotkeyInputEle = document.getElementById("hotkeyInput");
            hotkeyInputEle.value = "";
            lastShortcut = "";
            localStorage.removeItem("lastShortcut");
            const data = await Native.invoke("clearHotkey", {});
            alert(data.message);
        }

        document.addEventListener("DOMContentLoaded", async (event) => {
            // 启动时自动获取一次任务栏程序窗口列表
            await getWindows();

            const hotkeyInputEle = document.getElementById("hotkeyInput");
            // 如果用户上次退出程序时没有清楚全局快捷键，则在应用程序启动时自动注册，托盘图标菜单上的全局快捷键注册事件暂时不被记录
            lastShortcut = localStorage.getItem("lastShortcut");
            if (lastShortcut !== null) {
                hotkeyInputEle.value = lastShortcut;
                registerHotkey();
            }

            const modifierKeys = ["Control", "Shift", "Alt"];
            hotkeyInputEle.addEventListener("keydown", (event) => {
                // 忽略 IME 合成阶段或非可控按键
                if (event.keyCode === 229 || event.isComposing) return;

                // 防止长按重复触发
                if (event.repeat) return;

                // 如果是 Tab，允许原生焦点切换（可选）
                if (event.key === "Tab") return;

                // 只在我们确定要捕获时阻止默认
                event.preventDefault();

                let keys = [];
                if (event.ctrlKey) keys.push("Ctrl");
                if (event.shiftKey) keys.push("Shift");
                if (event.altKey) keys.push("Alt");

                if (!modifierKeys.includes(event.key)) {
                    let k =
                        event.key.length === 1
                            ? event.key.toUpperCase()
                            : event.key;
                    // space 特殊显示为 Space 更友好
                    if (k === " ") k = "Space";
                    keys.push(k);
                }

                if (keys.length === 0 || modifierKeys.includes(event.key)) {
                    hotkeyInputEle.value = "";
                    return;
                }

                lastShortcut = keys.join(" + ");
                hotkeyInputEle.value = lastShortcut;
            });

            const ulEle = document.getElementById("window-list");
            const windowFilterInputEle =
                document.getElementById("windowFilterInput");
            windowFilterInputEle.addEventListener("input", (event) => {
                const filterText = windowFilterInputEle.value.toLowerCase();
                Array.from(ulEle.children).forEach((li) => {
                    li.style.display = li.textContent
                        .toLowerCase()
                        .includes(filterText)
                        ? ""
                        : "none";
                });
            });
        });
    </script>
</html>

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Windows 任务栏窗口管理</title>
        <style>
            html {
                box-sizing: border-box;
            }

            *,
            *::before,
            *::after {
                margin: 0;
                padding: 0;
                box-sizing: inherit;
            }

            body {
                font-family: "Segoe UI", sans-serif;
                background: linear-gradient(
                    to right,
                    rgb(43, 192, 228),
                    rgb(234, 236, 198)
                );
                color: #333;
                height: 100vh;
                overflow: hidden;
                display: flex;
                flex-direction: column;
                padding: 20px;
                gap: 20px;
            }

            .toolbar {
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: rgba(255, 255, 255, 0.9);
                padding: 12px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
                width: 100%;
                max-width: 640px;
                margin: 0 auto;
            }

            .toolbar h1 {
                font-size: 1.4rem;
                color: #004578;
                margin: 0;
            }

            .toolbar-buttons {
                display: flex;
                gap: 8px;
            }

            .section {
                background: rgba(255, 255, 255, 0.8);
                padding: 16px;
                border-radius: 10px;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
                width: 100%;
                max-width: 640px;
                margin: 0 auto;
            }

            button {
                padding: 8px;
                font-size: 1rem;
                background: #0078d4;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
                min-width: 36px;
                height: 36px;
            }

            button:hover {
                background: #005fa3;
                transform: translateY(-1px);
            }

            button.exit-btn {
                background: #d83b01;
            }

            button.exit-btn:hover {
                background: #b02e00;
            }

            button.clear {
                background: #d83b01;
                padding: 8px 18px;
                min-width: auto;
                height: auto;
            }

            input {
                width: 100%;
                padding: 8px 10px;
                border: 1px solid #ccc;
                border-radius: 6px;
                font-size: 1rem;
                outline: none;
                transition: border 0.2s, box-shadow 0.2s;
            }

            input:focus {
                border-color: #0078d4;
                box-shadow: 0 0 4px rgba(0, 120, 212, 0.4);
            }

            h2 {
                font-size: 1.2rem;
                margin-bottom: 12px;
                color: #004578;
            }

            .hotkey-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 12px;
            }

            .hotkey-header h2 {
                margin-bottom: 0;
            }

            .hotkey-controls {
                display: flex;
                gap: 8px;
            }

            .hotkey-controls button {
                padding: 6px;
                min-width: 32px;
                height: 32px;
            }

            /* 窗口列表 - 关键部分 */
            .window-section {
                flex: 1;
                min-height: 0;
                display: flex;
                flex-direction: column;
            }

            .window-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 12px;
            }

            .window-header h2 {
                margin-bottom: 0;
            }

            .priority-info {
                font-size: 0.85rem;
                color: #666;
                background: rgba(0, 120, 212, 0.1);
                padding: 4px 8px;
                border-radius: 4px;
            }

            #window-list {
                flex: 1;
                min-height: 0;
                overflow-y: auto;
                list-style: none;
                margin-top: 12px;
            }

            #window-list::-webkit-scrollbar {
                width: 6px;
            }

            #window-list::-webkit-scrollbar-thumb {
                background: #c1c1c1;
                border-radius: 3px;
            }

            #window-list li {
                background: white;
                padding: 12px;
                margin-bottom: 6px;
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                justify-content: space-between;
                align-items: center;
                position: relative;
            }

            #window-list li:hover {
                background: #e6f0ff;
                transform: translateX(2px);
            }

            #window-list li.hover-target {
                background: #cce7ff;
                box-shadow: 0 2px 8px rgba(0, 120, 212, 0.3);
            }

            .window-title {
                flex: 1;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                margin-right: 12px;
            }

            .priority-badge {
                background: #0078d4;
                color: white;
                border-radius: 50%;
                width: 24px;
                height: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 0.8rem;
                font-weight: bold;
                min-width: 24px;
            }

            .priority-badge.high {
                background: #d83b01;
            }

            .priority-badge.medium {
                background: #ff8c00;
            }

            .priority-badge.low {
                background: #107c10;
            }

            .keyboard-hint {
                position: absolute;
                top: 50%;
                right: 40px;
                transform: translateY(-50%);
                font-size: 0.75rem;
                color: #666;
                background: rgba(255, 255, 255, 0.9);
                padding: 2px 6px;
                border-radius: 3px;
                border: 1px solid #ddd;
                opacity: 0;
                transition: opacity 0.2s;
                pointer-events: none;
            }

            #window-list li.hover-target .keyboard-hint {
                opacity: 1;
            }
        </style>
    </head>
    <body>
        <!-- 顶部工具栏 -->
        <div class="toolbar">
            <h1>Windows 任务栏管理器</h1>
            <div class="toolbar-buttons">
                <button onclick="getWindows()" title="刷新窗口列表">
                    <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <polyline points="1 4 1 10 7 10"></polyline>
                        <polyline points="23 20 23 14 17 14"></polyline>
                        <path
                            d="m20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"
                        ></path>
                    </svg>
                </button>
                <button onclick="quit()" title="退出" class="exit-btn">
                    <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    </svg>
                </button>
            </div>
        </div>

        <!-- 快捷键设置 -->
        <div class="section">
            <div class="hotkey-header">
                <h2>设置快捷键</h2>
                <div class="hotkey-controls">
                    <button onclick="registerHotkey()" title="注册快捷键">
                        <svg
                            width="14"
                            height="14"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </button>
                    <button
                        class="clear"
                        onclick="clearHotkey()"
                        title="清除快捷键"
                    >
                        <svg
                            width="14"
                            height="14"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
            </div>
            <input id="hotkeyInput" placeholder="例如 Ctrl+Alt+T" readonly />
        </div>

        <!-- 窗口列表 -->
        <div class="section window-section">
            <div class="window-header">
                <h2>窗口列表</h2>
                <div class="priority-info">
                    悬停窗口项 + 按数字键(0-9)设置优先级
                </div>
            </div>
            <input id="windowFilterInput" placeholder="输入窗口名称过滤..." />
            <ul id="window-list"></ul>
        </div>
    </body>
    <script>
        let lastShortcut = "";
        let windows = [];
        let windowPriorities = JSON.parse(
            localStorage.getItem("windowPriorities") || "{}"
        );
        let hoveredWindowIndex = -1;

        // 退出程序
        async function quit() {
            await Native.invoke("quit", {});
        }

        // 获取任务栏程序窗口列表
        async function getWindows() {
            const result = await Native.invoke("getWindows", {});
            windows = result.data.windows.map((window, index) => ({
                ...window,
                originalIndex: index,
                priority: windowPriorities[window.handle] || null,
            }));
            renderWindowList();
        }

        // 渲染窗口列表
        function renderWindowList() {
            // 根据优先级排序
            const sortedWindows = [...windows].sort((a, b) => {
                // 有优先级的排在前面
                if (a.priority !== null && b.priority === null) return -1;
                if (a.priority === null && b.priority !== null) return 1;
                // 都有优先级时，数字小的排在前面
                if (a.priority !== null && b.priority !== null) {
                    return a.priority - b.priority;
                }
                // 都没有优先级时，保持原顺序
                return a.originalIndex - b.originalIndex;
            });

            const ulEle = document.getElementById("window-list");
            ulEle.innerHTML = "";

            sortedWindows.forEach((window, index) => {
                const li = document.createElement("li");
                li.dataset.windowHandle = window.handle;
                li.dataset.windowIndex = index;

                // 窗口标题
                const titleDiv = document.createElement("div");
                titleDiv.className = "window-title";
                titleDiv.textContent = window.title.substring(0, 64);
                li.appendChild(titleDiv);

                // 键盘提示
                const hintDiv = document.createElement("div");
                hintDiv.className = "keyboard-hint";
                hintDiv.textContent = "按 0-9 设置优先级";
                li.appendChild(hintDiv);

                // 优先级徽章
                if (window.priority !== null) {
                    const badge = document.createElement("div");
                    badge.className = "priority-badge";
                    if (window.priority <= 2) badge.classList.add("high");
                    else if (window.priority <= 5)
                        badge.classList.add("medium");
                    else badge.classList.add("low");
                    badge.textContent = window.priority;
                    li.appendChild(badge);
                }

                // 事件监听
                li.addEventListener("mouseenter", () => {
                    hoveredWindowIndex = index;
                    li.classList.add("hover-target");
                });

                li.addEventListener("mouseleave", () => {
                    hoveredWindowIndex = -1;
                    li.classList.remove("hover-target");
                });

                li.addEventListener("click", () => {
                    activateWindow(window.handle);
                });

                ulEle.appendChild(li);
            });

            // 应用过滤
            applyFilter();
        }

        // 设置窗口优先级
        function setWindowPriority(priority) {
            if (hoveredWindowIndex === -1) return;

            const sortedWindows = [...windows].sort((a, b) => {
                if (a.priority !== null && b.priority === null) return -1;
                if (a.priority === null && b.priority !== null) return 1;
                if (a.priority !== null && b.priority !== null) {
                    return a.priority - b.priority;
                }
                return a.originalIndex - b.originalIndex;
            });

            const window = sortedWindows[hoveredWindowIndex];
            if (!window) return;

            // 更新优先级
            windowPriorities[window.handle] = priority;
            localStorage.setItem(
                "windowPriorities",
                JSON.stringify(windowPriorities)
            );

            // 重新获取和渲染
            getWindows();
        }

        // 应用过滤
        function applyFilter() {
            const filterText = document
                .getElementById("windowFilterInput")
                .value.toLowerCase();
            const ulEle = document.getElementById("window-list");
            Array.from(ulEle.children).forEach((li) => {
                const titleText = li
                    .querySelector(".window-title")
                    .textContent.toLowerCase();
                li.style.display = titleText.includes(filterText) ? "" : "none";
            });
        }

        // 激活窗口
        async function activateWindow(handle) {
            await Native.invoke("activateWindow", {
                handle: handle,
            });
        }

        // 注册全局快捷键
        async function registerHotkey() {
            const forbidden = [
                "Ctrl + A",
                "Ctrl + C",
                "Ctrl + V",
                "Ctrl + X",
                "Ctrl + Z",
                "Alt + Tab",
                "Alt + F4",
            ];
            if (forbidden.includes(lastShortcut)) {
                alert("该快捷键与系统快捷键冲突，无法注册");
                return;
            }

            const parts = lastShortcut.split(" + ").map((p) => p.trim());
            const info = {
                ctrl: parts.includes("Ctrl"),
                shift: parts.includes("Shift"),
                alt: parts.includes("Alt"),
                key:
                    parts.find((p) => !["Ctrl", "Shift", "Alt"].includes(p)) ||
                    "",
            };

            if (!info.key) {
                alert("快捷键无效：缺少主键");
                return;
            }

            localStorage.setItem("lastShortcut", lastShortcut);
            const result = await Native.invoke("registerHotkey", {
                hotkey: info,
            });
        }

        // 清除全局快捷键
        async function clearHotkey() {
            const hotkeyInputEle = document.getElementById("hotkeyInput");
            hotkeyInputEle.value = "";
            lastShortcut = "";
            localStorage.removeItem("lastShortcut");
            const result = await Native.invoke("clearHotkey", {});
            alert(result.msg);
        }

        // 键盘事件监听
        document.addEventListener("keydown", (event) => {
            // 检查是否按下数字键 0-9
            if (event.key >= "0" && event.key <= "9") {
                const priority = parseInt(event.key);
                setWindowPriority(priority);
                event.preventDefault();
            }
        });

        document.addEventListener("DOMContentLoaded", async (event) => {
            // 启动时自动获取一次任务栏程序窗口列表
            await getWindows();

            const hotkeyInputEle = document.getElementById("hotkeyInput");
            lastShortcut = localStorage.getItem("lastShortcut");
            if (lastShortcut !== null) {
                hotkeyInputEle.value = lastShortcut;
                registerHotkey();
            }

            const modifierKeys = ["Control", "Shift", "Alt"];
            hotkeyInputEle.addEventListener("keydown", (event) => {
                if (event.keyCode === 229 || event.isComposing) return;
                if (event.repeat) return;
                if (event.key === "Tab") return;

                event.preventDefault();

                let keys = [];
                if (event.ctrlKey) keys.push("Ctrl");
                if (event.shiftKey) keys.push("Shift");
                if (event.altKey) keys.push("Alt");

                if (!modifierKeys.includes(event.key)) {
                    let k =
                        event.key.length === 1
                            ? event.key.toUpperCase()
                            : event.key;
                    if (k === " ") k = "Space";
                    keys.push(k);
                }

                if (keys.length === 0 || modifierKeys.includes(event.key)) {
                    hotkeyInputEle.value = "";
                    return;
                }

                lastShortcut = keys.join(" + ");
                hotkeyInputEle.value = lastShortcut;
            });

            const windowFilterInputEle =
                document.getElementById("windowFilterInput");
            windowFilterInputEle.addEventListener("input", applyFilter);
        });
    </script>
</html>

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Windows 任务栏窗口管理</title>
        <style>
            html {
                box-sizing: border-box;
            }

            *,
            *::before,
            *::after {
                margin: 0;
                padding: 0;
                box-sizing: inherit;
            }

            body {
                font-family: "Segoe UI", sans-serif;
                background: linear-gradient(
                    to right,
                    rgb(43, 192, 228),
                    rgb(234, 236, 198)
                );
                color: #333;
                height: 100vh;
                overflow: hidden;
                display: flex;
                flex-direction: column;
                padding: 20px;
                gap: 20px;
            }

            .toolbar {
                display: flex;
                justify-content: space-between;
                align-items: center;
                background: rgba(255, 255, 255, 0.9);
                padding: 12px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
                width: 100%;
                max-width: 640px;
                margin: 0 auto;
            }

            .toolbar h1 {
                font-size: 1.4rem;
                color: #004578;
                margin: 0;
            }

            .toolbar-buttons {
                display: flex;
                gap: 8px;
            }

            .section {
                background: rgba(255, 255, 255, 0.8);
                padding: 16px;
                border-radius: 10px;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
                width: 100%;
                max-width: 640px;
                margin: 0 auto;
            }

            button {
                padding: 8px;
                font-size: 1rem;
                background: #0078d4;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                transition: all 0.2s;
                display: flex;
                align-items: center;
                justify-content: center;
                min-width: 36px;
                height: 36px;
            }

            button:hover {
                background: #005fa3;
                transform: translateY(-1px);
            }

            button.exit-btn {
                background: #d83b01;
            }

            button.exit-btn:hover {
                background: #b02e00;
            }

            button.clear {
                background: #d83b01;
                padding: 8px 18px;
                min-width: auto;
                height: auto;
            }

            input {
                width: 100%;
                padding: 8px 10px;
                border: 1px solid #ccc;
                border-radius: 6px;
                font-size: 1rem;
                outline: none;
                transition: border 0.2s, box-shadow 0.2s;
            }

            input:focus {
                border-color: #0078d4;
                box-shadow: 0 0 4px rgba(0, 120, 212, 0.4);
            }

            h2 {
                font-size: 1.2rem;
                margin-bottom: 12px;
                color: #004578;
            }

            .hotkey-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 12px;
            }

            .hotkey-header h2 {
                margin-bottom: 0;
            }

            .hotkey-controls {
                display: flex;
                gap: 8px;
            }

            .hotkey-controls button {
                padding: 6px;
                min-width: 32px;
                height: 32px;
            }

            /* 窗口列表 - 关键部分 */
            .window-section {
                flex: 1;
                min-height: 0;
                display: flex;
                flex-direction: column;
            }

            #window-list {
                flex: 1;
                min-height: 0;
                overflow-y: auto;
                list-style: none;
                margin-top: 12px;
            }

            #window-list::-webkit-scrollbar {
                width: 6px;
            }

            #window-list::-webkit-scrollbar-thumb {
                background: #c1c1c1;
                border-radius: 3px;
            }

            #window-list li {
                background: white;
                padding: 12px;
                margin-bottom: 6px;
                border-radius: 6px;
                cursor: pointer;
                transition: background 0.2s;
            }

            #window-list li:hover {
                background: #e6f0ff;
            }
        </style>
    </head>
    <body>
        <!-- 顶部工具栏 -->
        <div class="toolbar">
            <h1>Windows 任务栏管理器</h1>
            <div class="toolbar-buttons">
                <button onclick="getWindows()" title="刷新窗口列表">
                    <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <polyline points="1 4 1 10 7 10"></polyline>
                        <polyline points="23 20 23 14 17 14"></polyline>
                        <path
                            d="m20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"
                        ></path>
                    </svg>
                </button>
                <button onclick="quit()" title="退出" class="exit-btn">
                    <svg
                        width="16"
                        height="16"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                    >
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="15" y1="9" x2="9" y2="15"></line>
                        <line x1="9" y1="9" x2="15" y2="15"></line>
                    </svg>
                </button>
            </div>
        </div>

        <!-- 快捷键设置 -->
        <div class="section">
            <div class="hotkey-header">
                <h2>设置快捷键</h2>
                <div class="hotkey-controls">
                    <button onclick="registerHotkey()" title="注册快捷键">
                        <svg
                            width="14"
                            height="14"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </button>
                    <button
                        class="clear"
                        onclick="clearHotkey()"
                        title="清除快捷键"
                    >
                        <svg
                            width="14"
                            height="14"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                        >
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
            </div>
            <input id="hotkeyInput" placeholder="例如 Ctrl+Alt+T" readonly />
        </div>

        <!-- 窗口列表 -->
        <div class="section window-section">
            <h2>窗口列表</h2>
            <input id="windowFilterInput" placeholder="输入窗口名称过滤..." />
            <ul id="window-list"></ul>
        </div>
    </body>
    <script>
        let lastShortcut = "";

        // 退出程序
        async function quit() {
            await Native.invoke("quit", {});
        }

        // 获取任务栏程序窗口列表
        async function getWindows() {
            const data = await Native.invoke("getWindows", {});
            const ulEle = document.getElementById("window-list");
            ulEle.innerHTML = "";

            data.windows.forEach((window) => {
                const li = document.createElement("li");
                li.textContent = window.title.substring(0, 64);
                li.onclick = () => {
                    activateWindow(window.handle);
                };
                ulEle.appendChild(li);
            });
        }

        // 激活窗口
        async function activateWindow(handle) {
            await Native.invoke("activateWindow", { handle: handle });
        }

        // 注册全局快捷键
        async function registerHotkey() {
            // 系统禁止的快捷键，避免冲突
            const forbidden = [
                "Ctrl + A",
                "Ctrl + C",
                "Ctrl + V",
                "Ctrl + X",
                "Ctrl + Z",
                "Alt + Tab",
                "Alt + F4",
            ];
            if (forbidden.includes(lastShortcut)) {
                alert("该快捷键与系统快捷键冲突，无法注册");
                return;
            }

            // 拆解为结构化对象
            const parts = lastShortcut.split(" + ").map((p) => p.trim());
            const info = {
                ctrl: parts.includes("Ctrl"),
                shift: parts.includes("Shift"),
                alt: parts.includes("Alt"),
                key:
                    parts.find((p) => !["Ctrl", "Shift", "Alt"].includes(p)) ||
                    "",
            };

            if (!info.key) {
                alert("快捷键无效：缺少主键");
                return;
            }

            localStorage.setItem("lastShortcut", lastShortcut);
            const data = await Native.invoke("registerHotkey", {
                hotkey: info,
            });
        }

        // 清除全局快捷键
        async function clearHotkey() {
            const hotkeyInputEle = document.getElementById("hotkeyInput");
            hotkeyInputEle.value = "";
            lastShortcut = "";
            localStorage.removeItem("lastShortcut");
            const data = await Native.invoke("clearHotkey", {});
            alert(data.message);
        }

        document.addEventListener("DOMContentLoaded", async (event) => {
            // 启动时自动获取一次任务栏程序窗口列表
            await getWindows();

            const hotkeyInputEle = document.getElementById("hotkeyInput");
            // 如果用户上次退出程序时没有清楚全局快捷键，则在应用程序启动时自动注册，托盘图标菜单上的全局快捷键注册事件暂时不被记录
            lastShortcut = localStorage.getItem("lastShortcut");
            if (lastShortcut !== null) {
                hotkeyInputEle.value = lastShortcut;
                registerHotkey();
            }

            const modifierKeys = ["Control", "Shift", "Alt"];
            hotkeyInputEle.addEventListener("keydown", (event) => {
                // 忽略 IME 合成阶段或非可控按键
                if (event.keyCode === 229 || event.isComposing) return;

                // 防止长按重复触发
                if (event.repeat) return;

                // 如果是 Tab，允许原生焦点切换（可选）
                if (event.key === "Tab") return;

                // 只在我们确定要捕获时阻止默认
                event.preventDefault();

                let keys = [];
                if (event.ctrlKey) keys.push("Ctrl");
                if (event.shiftKey) keys.push("Shift");
                if (event.altKey) keys.push("Alt");

                if (!modifierKeys.includes(event.key)) {
                    let k =
                        event.key.length === 1
                            ? event.key.toUpperCase()
                            : event.key;
                    // space 特殊显示为 Space 更友好
                    if (k === " ") k = "Space";
                    keys.push(k);
                }

                if (keys.length === 0 || modifierKeys.includes(event.key)) {
                    hotkeyInputEle.value = "";
                    return;
                }

                lastShortcut = keys.join(" + ");
                hotkeyInputEle.value = lastShortcut;
            });

            const ulEle = document.getElementById("window-list");
            const windowFilterInputEle =
                document.getElementById("windowFilterInput");
            windowFilterInputEle.addEventListener("input", (event) => {
                const filterText = windowFilterInputEle.value.toLowerCase();
                Array.from(ulEle.children).forEach((li) => {
                    li.style.display = li.textContent
                        .toLowerCase()
                        .includes(filterText)
                        ? ""
                        : "none";
                });
            });
        });
    </script>
</html>
